name: gds
# either manually started, or on a schedule
on: [ push, workflow_dispatch ]
permissions:
  contents: write
  pages: write
  id-token: write
jobs:
  gds:
  env:
      OPENLANE_IMAGE_NAME: efabless/openlane:2022.07.02_01.38.08
      OPENLANE_ROOT: /home/runner/openlane
      PDK_ROOT: /home/runner/pdk
      PDK: sky130B
      SYNTH_HDL_FRONTEND: slang  # ðŸ‘ˆ Added this line

  runs-on: ubuntu-latest
  steps:
  - name: checkout repo
    uses: actions/checkout@v3

  - name: pdk & caravel
    run: |
      cd $HOME
      git clone https://github.com/efabless/caravel_user_project.git -b mpw-7a
      cd caravel_user_project
      make setup

  - name: setup python
    uses: actions/setup-python@v4
    with:
      python-version: '3.10'
  - run: pip install requests PyYAML

  - name: Make configure.py executable
    run: chmod +x configure.py

  - name: fetch Verilog and build config
    run: ./configure.py --create-user-config

  - name: make GDS
    run: >
      docker run --rm
      -v $OPENLANE_ROOT:/openlane
      -v $PDK_ROOT:$PDK_ROOT
      -v $(pwd):/work
      -e PDK_ROOT=$PDK_ROOT
      -e SYNTH_HDL_FRONTEND=$SYNTH_HDL_FRONTEND   # ðŸ‘ˆ Pass it into container too
      -u $(id -u $USER):$(id -g $USER)
      $OPENLANE_IMAGE_NAME
      /bin/bash -c "./flow.tcl -verbose 2 -overwrite -design /work/src -run_path /work/runs -tag wokwi"

  - name: show files
    run: find runs/wokwi/

  - name: add summary
    run: ./configure.py --get-stats >> $GITHUB_STEP_SUMMARY

  - name: populate src cache
    uses: actions/cache@v3
    with:
      path: src
      key: ${{ runner.os }}-src-${{ github.run_id }}

  - name: populate runs cache
    uses: actions/cache@v3
    with:
      path: runs
      key: ${{ runner.os }}-runs-${{ github.run_id }}
